<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MotoLog - My Rides</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <div class="dashboard-container">
    {% include '_navbar.html' %}
    
    <div style="padding: 20px;">
      <h1 style="color: var(--text); font-size: 32px; font-weight: bold; margin: 20px 0;">My Ride History</h1>
      
      {% if rides_list %}
        <!-- Stats Bar -->
        <div style="background-color: var(--card-bg); padding: 20px; margin-bottom: 30px; border-radius: 8px; box-shadow: var(--shadow-1);">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <div>
              <p style="color: var(--muted); font-size: 14px; margin: 0; font-weight: 500;">TOTAL RIDES</p>
              <p style="color: var(--text); font-size: 24px; font-weight: bold; margin: 8px 0 0 0;">{{ rides_list|length }}</p>
            </div>
            <div>
              <p style="color: var(--muted); font-size: 14px; margin: 0; font-weight: 500;">TOTAL DISTANCE</p>
              <p style="color: var(--text); font-size: 24px; font-weight: bold; margin: 8px 0 0 0;">{{ total_distance|round(1) }} km</p>
            </div>
            <div>
              <p style="color: var(--muted); font-size: 14px; margin: 0; font-weight: 500;">SHARED RIDES</p>
              <p style="color: var(--text); font-size: 24px; font-weight: bold; margin: 8px 0 0 0;">{{ shared_count }}</p>
            </div>
          </div>
        </div>
        
        <!-- Rides Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
          {% for ride in rides_list %}
          <div data-ride-id="{{ ride.id }}" class="ride-card-enhanced" style="background-color: var(--card-bg); border: 1px solid var(--n-300); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <h3 style="color: var(--text); font-size: 18px; font-weight: bold; margin: 0;">{{ ride.title or 'Untitled Ride' }}</h3>
              {% if ride.public == 1 %}
              <span class="badge badge-public" style="background-color: var(--primary-500); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">PUBLIC</span>
              {% else %}
              <span class="badge badge-private" style="background-color: var(--n-300); color: var(--muted); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">PRIVATE</span>
              {% endif %}
            </div>
            
            {% if ride.description %}
            <p style="color: var(--muted); font-size: 14px; margin: 0 0 12px 0;">{{ ride.description }}</p>
            {% endif %}
            
            <p style="color: var(--muted); font-size: 12px; margin: 0 0 12px 0;">ðŸ“… {{ ride.date }}</p>
            
            <!-- Stats -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--n-300);">
              <div>
                <p style="color: var(--muted); font-size: 12px; margin: 0;">Distance</p>
                <p style="color: var(--text); font-size: 16px; font-weight: bold; margin: 4px 0 0 0;">{{ ride.distance|round(1) }} km</p>
              </div>
              <div>
                <p style="color: var(--muted); font-size: 12px; margin: 0;">Avg Speed</p>
                <p style="color: var(--text); font-size: 16px; font-weight: bold; margin: 4px 0 0 0;">{{ ride.avg_speed|round(1) }} km/h</p>
              </div>
              <div>
                <p style="color: var(--muted); font-size: 12px; margin: 0;">Duration</p>
                <p style="color: var(--text); font-size: 16px; font-weight: bold; margin: 4px 0 0 0;">{{ ride.time }}</p>
              </div>
              <div>
                <p style="color: var(--muted); font-size: 12px; margin: 0;">Top Speed</p>
                <p style="color: var(--text); font-size: 16px; font-weight: bold; margin: 4px 0 0 0;">{{ ride.top_speed|round(1) }} km/h</p>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 8px;">
              <button onclick="location.href='/ride/{{ ride.id }}'" style="flex: 1; background-color: var(--primary-500); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">View</button>
              <button onclick="togglePublic({{ ride.id }}, {{ 1 if ride.public == 0 else 0 }})" style="flex: 1; background-color: #10b981; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">{% if ride.public == 1 %}Make Private{% else %}Make Public{% endif %}</button>
              <button onclick="deleteRide({{ ride.id }})" style="flex: 1; background-color: #ef4444; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">Delete</button>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <!-- Empty State -->
        <div style="text-align: center; padding: 60px 20px; background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow-1);">
          <h2 style="color: var(--muted); font-size: 24px; font-weight: bold; margin: 0;">No rides yet!</h2>
          <p style="color: var(--muted); font-size: 16px; margin: 12px 0;">Start tracking your first ride today</p>
          <a href="/track-ride" style="display: inline-block; background-color: var(--primary-500); color: white; padding: 12px 24px; border-radius: 4px; text-decoration: none; font-weight: 500; margin-top: 12px;">Start Tracking</a>
        </div>
      {% endif %}
    </div>
  </div>

  <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-2); max-width: 400px; width: 90%; text-align: center;">
      <h3 style="color: var(--text); margin: 0 0 16px 0; font-size: 18px;">Delete Ride</h3>
      <p style="color: var(--muted); margin: 0 0 24px 0;">Are you sure you want to delete this ride? This action cannot be undone.</p>
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="cancelDelete" style="background: var(--n-300); color: var(--text); border: none; padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer;">Cancel</button>
        <button id="confirmDelete" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" style="display: none; position: fixed; top: 20px; right: 20px; background: var(--card-bg); color: var(--text); padding: 12px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-2); z-index: 1001; font-weight: 500;">
    <span id="toastMessage"></span>
  </div>

  <script>
    let rideToDelete = null;

    function togglePublic(rideId, makePublic) {
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = 'Updating...';
      button.disabled = true;

      fetch(`/api/ride/toggle-public`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ride_id: rideId, public: makePublic })
      })
      .then(r => {
        if (!r.ok) {
          throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        return r.json();
      })
      .then(data => {
        if (data.success) {
          // Update the badge
          const card = button.closest('.ride-card-enhanced');
          const badge = card.querySelector('.badge');
          if (makePublic) {
            badge.className = 'badge badge-public';
            badge.textContent = 'PUBLIC';
            button.innerHTML = 'Make Private';
            button.onclick = () => togglePublic(rideId, 0);
          } else {
            badge.className = 'badge badge-private';
            badge.textContent = 'PRIVATE';
            button.innerHTML = 'Make Public';
            button.onclick = () => togglePublic(rideId, 1);
          }
          showToast(data.message || 'Ride visibility updated');
        } else {
          showToast(data.error || 'Error updating ride visibility', true);
          button.innerHTML = originalText;
        }
        button.disabled = false;
      })
      .catch(e => {
        console.error('Error:', e);
        showToast('Error updating ride visibility: ' + e.message, true);
        button.innerHTML = originalText;
        button.disabled = false;
      });
    }

    function deleteRide(rideId) {
      rideToDelete = rideId;
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function confirmDelete() {
      if (!rideToDelete) return;
      
      const button = document.getElementById('confirmDelete');
      const originalText = button.innerHTML;
      button.innerHTML = 'Deleting...';
      button.disabled = true;

      fetch('/api/ride/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ride_id: rideToDelete })
      })
      .then(r => {
        if (!r.ok) {
          throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        return r.json();
      })
      .then(data => {
        if (data.success) {
          // Remove the ride card
          const card = document.querySelector(`[data-ride-id="${rideToDelete}"]`);
          if (card) {
            card.remove();
          }
          // Update stats
          updateStats();
          showToast('Ride deleted successfully');
          document.getElementById('deleteModal').style.display = 'none';
        } else {
          showToast(data.error || 'Error deleting ride', true);
        }
        button.innerHTML = originalText;
        button.disabled = false;
        rideToDelete = null;
      })
      .catch(e => {
        console.error('Error:', e);
        showToast('Error deleting ride: ' + e.message, true);
        button.innerHTML = originalText;
        button.disabled = false;
      });
    }

    function updateStats() {
      // This would require fetching updated stats from server
      // For now, just reload to keep it simple
      setTimeout(() => location.reload(), 100);
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.style.background = isError ? '#ef4444' : 'var(--card-bg)';
      toast.style.color = isError ? 'white' : 'var(--text)';
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // Modal event listeners
    document.getElementById('cancelDelete').addEventListener('click', () => {
      document.getElementById('deleteModal').style.display = 'none';
      rideToDelete = null;
    });

    document.getElementById('confirmDelete').addEventListener('click', confirmDelete);

    // Close modal on outside click
    document.getElementById('deleteModal').addEventListener('click', (e) => {
      if (e.target.id === 'deleteModal') {
        document.getElementById('deleteModal').style.display = 'none';
        rideToDelete = null;
      }
    });
  </script>
</body>
</html>
