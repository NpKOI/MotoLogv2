<nav class="navbar">
  <div class="brand">üèçÔ∏è MotoLog</div>

  <div class="navbar-links">
    <a href="/dashboard">Dashboard</a>
    <a href="/leaderboard">Leaderboard</a>
    <a href="/tools">Tools</a>
  </div>

  {% if session.get('user_id') %}
    {% set u = query_db('SELECT profile_pic, username FROM users WHERE id = ?', (session['user_id'],), one=True) %}
    <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
      <!-- Messages icon (paper-plane outline) -->
      <a href="/messages" id="messagesLink" title="Messages" style="position:relative; display:inline-flex; align-items:center; text-decoration:none; color:inherit;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      </a>

      <!-- Search icon (opens modal) -->
      <button id="searchToggle" title="Search users" style="background:transparent; border:none; cursor:pointer; padding:6px; display:inline-flex; align-items:center;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5"/>
          <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- Profile -->
      <div class="profile" style="position:relative;">
        <div class="profile-avatar" id="profileBtn" title="Account" style="cursor:pointer;">
          {% if u and u['profile_pic'] %}
            <img src="{{ u['profile_pic'] }}" alt="Profile" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
          {% else %}
            <div style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#667eea;color:white;font-weight:bold;">{{ u['username'][0].upper() if u else 'U' }}</div>
          {% endif %}
        </div>

        <div class="profile-menu" id="profileMenu" style="display:none; position:absolute; right:0; margin-top:8px; background:white; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; min-width:160px;">
          <a href="/profile" style="display:block; padding:10px 12px; text-decoration:none; color:inherit;">Profile</a>
          <a href="/bikes" style="display:block; padding:10px 12px; text-decoration:none; color:inherit;">My Garage</a>
          <a href="/add-bike" style="display:block; padding:10px 12px; text-decoration:none; color:inherit;">Add Bike</a>
          <a href="/logout" style="display:block; padding:10px 12px; text-decoration:none; color:inherit;">Logout</a>
        </div>
      </div>
    </div>
  {% endif %}
</nav>

<!-- Nav search modal (hidden by default) -->
<div id="navSearchModal" style="display:none; position:fixed; top:72px; right:20px; width:360px; max-width:92%; z-index:2000;">
  <div style="background:white; border-radius:8px; box-shadow:0 12px 36px rgba(0,0,0,0.18); padding:12px;">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="navSearchInput" type="search" placeholder="Search users by username..." aria-label="Search users"
             style="flex:1; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:0.95rem;">
      <button id="navSearchClose" style="background:#f0f2f5; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">‚úï</button>
    </div>
    <div id="navSearchResults" style="margin-top:8px; max-height:320px; overflow:auto;"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    // profile dropdown
    const btn = document.getElementById('profileBtn');
    const menu = document.getElementById('profileMenu');
    if (btn && menu) {
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', function(){ if (menu) menu.style.display = 'none'; });
    }

    // unread badge updater (keeps working with the messages anchor)
    function updateMessagesNotificationBadge() {
      fetch('/messages/unread-count')
        .then(response => response.json())
        .then(data => {
          const messagesLinks = document.querySelectorAll('a[href="/messages"]');
          messagesLinks.forEach(link => {
            if (data.unread_count > 0) {
              let badge = link.querySelector('.msg-unread-badge');
              if (!badge) {
                badge = document.createElement('span');
                badge.className = 'msg-unread-badge';
                badge.style.cssText = 'display:inline-block;background:#f5576c;color:white;width:18px;height:18px;border-radius:50%;text-align:center;line-height:18px;font-size:0.7rem;font-weight:700;margin-left:6px;box-shadow:0 2px 8px rgba(245,87,108,0.3);position:absolute;top:-6px;right:-6px;';
                link.appendChild(badge);
              }
              badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
            } else {
              const badge = link.querySelector('.msg-unread-badge');
              if (badge) badge.remove();
            }
          });
        })
        .catch(error => console.error('Badge update error:', error));
    }

    updateMessagesNotificationBadge();
    setInterval(updateMessagesNotificationBadge, 3000);

    // Search modal behavior
    const toggle = document.getElementById('searchToggle');
    const modal = document.getElementById('navSearchModal');
    const input = document.getElementById('navSearchInput');
    const results = document.getElementById('navSearchResults');
    const closeBtn = document.getElementById('navSearchClose');

    if (toggle && modal && input && results) {
      toggle.addEventListener('click', function(e){
        e.preventDefault();
        modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
        if (modal.style.display === 'block') { input.focus(); input.select(); results.innerHTML = ''; }
      });

      closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });

      let timer = null;
      input.addEventListener('input', function(){
        clearTimeout(timer);
        const q = input.value.trim();
        if (!q) { results.innerHTML = ''; return; }
        timer = setTimeout(() => {
          fetch('/search/users?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
              results.innerHTML = '';
              if (!data.users || data.users.length === 0) {
                results.innerHTML = '<div style="color:#666; padding:8px;">No users found</div>';
                return;
              }
              data.users.forEach(u => {
                const a = document.createElement('a');
                a.href = '/user/' + u.id;
                a.style.display = 'flex';
                a.style.gap = '8px';
                a.style.padding = '8px';
                a.style.alignItems = 'center';
                a.style.textDecoration = 'none';
                a.style.color = 'inherit';
                a.innerHTML = `
                  <div style="width:44px;height:44px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid #667eea;">
                    ${u.profile_pic ? `<img src="${u.profile_pic}" style="width:100%;height:100%;object-fit:cover;">` 
                                     : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#667eea;color:white;font-weight:700;">${u.username.charAt(0).toUpperCase()}</div>`}
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:700;">${u.username}</div>
                    <div style="color:#666;font-size:0.85rem;">View profile</div>
                  </div>
                `;
                results.appendChild(a);
              });
            })
            .catch(err => { console.error('Search error:', err); results.innerHTML = '<div style="color:#c00;padding:8px;">Search failed</div>'; });
        }, 220);
      });
    }

    // close modal when clicking outside
    document.addEventListener('click', function(e){
      if (!modal || modal.style.display === 'none') return;
      const within = modal.contains(e.target) || (toggle && toggle.contains(e.target));
      if (!within) modal.style.display = 'none';
    });
  });
</script>