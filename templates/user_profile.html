<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MotoLog - {{ user['username'] }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    .ride-card-enhanced {
      background: linear-gradient(180deg, var(--card-bg), color-mix(in srgb, var(--card-bg) 96%, var(--glass) 4%));
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-1);
      border-left: 4px solid var(--primary-500);
      transition: all 0.2s ease;
    }
    .ride-card-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-2);
    }
    .ride-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 12px;
    }
    .ride-date {
      font-weight: 800;
      color: var(--primary-600);
      font-size: 1.1rem;
    }
    .ride-distance {
      font-weight: 800;
      color: var(--text);
      font-size: 1.2rem;
    }
    .ride-meta {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 2px;
    }
    .ride-description {
      color: var(--text);
      margin: 12px 0;
      line-height: 1.5;
      font-size: 0.97rem;
    }
    .ride-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0;
    }
    .ride-tag {
      background: color-mix(in srgb, var(--primary-500) 6%, transparent);
      color: var(--primary-600);
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.82rem;
    }
    .ride-divider {
      height: 1px;
      background: color-mix(in srgb, var(--muted) 12%, transparent);
      margin: 16px 0;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    {% include '_navbar.html' %}

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar-large{% if user['profile_pic'] %} {% else %} circle{% endif %}">
        {% if user['profile_pic'] %}
          <a href="/user/{{ user['id'] }}" aria-label="{{ user['username'] }}'s profile">
            <img src="{{ user['profile_pic'] }}" alt="{{ user['username'] }}">
          </a>
        {% else %}
          <a href="/user/{{ user['id'] }}" aria-label="{{ user['username'] }}'s profile" style="display:flex; width:100%; height:100%; align-items:center; justify-content:center; text-decoration:none; color:white; font-weight:800;">
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:3rem; background:linear-gradient(135deg,var(--primary-500),var(--primary-600));">
              {{ user['username'][0].upper() }}
            </div>
          </a>
        {% endif %}
      </div>

      <div class="profile-details">
        <h1 class="profile-username">{{ user['username'] }}</h1>

        <div class="profile-stats" style="margin-top:12px;">
          <a href="/user/{{ user['id'] }}" style="text-decoration:none; color:inherit;">
            <div class="stat">
              <div class="stat-value">{{ total_rides }}</div>
              <div class="stat-label">Public Rides</div>
            </div>
          </a>

          <a href="/user/{{ user['id'] }}/followers" style="text-decoration:none; color:inherit;">
            <div class="stat">
              <div class="stat-value">{{ followers|length }}</div>
              <div class="stat-label">Followers</div>
            </div>
          </a>

          <a href="/user/{{ user['id'] }}/following" style="text-decoration:none; color:inherit;">
            <div class="stat">
              <div class="stat-value">{{ following|length }}</div>
              <div class="stat-label">Following</div>
            </div>
          </a>
        </div>

        {% if user['bio'] %}
          <div class="profile-bio" style="margin-top:12px;">{{ user['bio'] }}</div>
        {% endif %}

        <div style="margin-top:10px; color:var(--muted); font-weight:700;">
          üìç {{ user['country'] }}
        </div>

        <div class="action-buttons" style="margin-top:14px;">
          {% if session.get('user_id') and session['user_id'] != user['id'] %}
            <form method="POST" action="/follow/{{ user['id'] }}" style="display:inline;">
              <button class="action-btn follow-btn {% if is_following %}unfollow{% endif %}" type="submit">
                {{ '‚úì Following' if is_following else '+ Follow' }}
              </button>
            </form>
            <a href="/messages/with/{{ user['id'] }}" class="action-btn message-btn">üí¨ Message</a>
          {% endif %}
          <a href="/user/{{ user['id'] }}/garage" class="action-btn garage-btn">üèçÔ∏è Garage</a>
        </div>
      </div>
    </div>

    <!-- Public Rides Section -->
    <div class="profile-section" style="margin-top:28px;">
      <h3 style="margin:0 0 16px 0; color:var(--text);">üèçÔ∏è Recent Public Rides ({{ rides|length }})</h3>

      {% if rides %}
        <div style="margin-top:12px;">
          {% for ride in rides %}
            <div class="ride-card-enhanced">
              <div class="ride-header">
                <div>
                  <div class="ride-date">üìÖ {{ ride['date'] }}</div>
                  <div class="ride-meta">{{ ride['description'] or 'No description' }}</div>
                </div>
                <div style="text-align:right;">
                  <div class="ride-distance">{{ ride['distance'] }} km</div>
                  <div class="ride-meta">‚è±Ô∏è {{ ride['time'] }} hrs</div>
                </div>
              </div>

              {% if ride['tags'] %}
                <div class="ride-tags">
                  {% set tags = (ride['tags'] or '').split(',') %}
                  {% for tag in tags %}
                    {% set t = tag.strip() %}
                    {% if t %}
                      <div class="ride-tag">{{ t }}</div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}

              <!-- Comments Section -->
              <div style="margin-top:12px; padding-top:12px; border-top: 1px solid color-mix(in srgb,var(--muted) 8%, transparent);">
                <div style="font-weight:700; color:var(--text); margin-bottom:10px;">üí¨ Comments</div>

                {% set ride_comments = query_db('SELECT c.*, u.username, u.profile_pic FROM comments c JOIN users u ON c.user_id = u.id WHERE c.ride_id = ? ORDER BY c.created_at DESC', (ride['id'],)) %}
                {% if ride_comments %}
                  {% for comment in ride_comments %}
                    <div style="background:color-mix(in srgb,var(--card-bg) 96%, var(--glass) 4%); padding:10px 12px; border-radius:8px; margin-bottom:8px;">
                      <div style="font-weight:700; color:var(--text); font-size:0.95rem;">{{ comment['username'] }}</div>
                      <div style="color:var(--text); margin-top:4px; font-size:0.93rem;">{{ comment['content'] }}</div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div style="color:var(--muted); font-size:0.95rem;">No comments yet. Be the first to comment!</div>
                {% endif %}

                {% if session.get('user_id') %}
                  <form method="POST" action="/ride/{{ ride['id'] }}/comment" style="margin-top:10px; display:flex; gap:8px;">
                    <input type="text" name="comment" style="flex:1; padding:8px 10px; border-radius:6px; border:1px solid color-mix(in srgb,var(--muted) 8%, transparent); background:transparent; color:var(--text); font-family:inherit;" placeholder="Share your thoughts..." required>
                    <button type="submit" class="comment-submit" style="padding:8px 14px; font-size:0.9rem;">Post</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="stat-card" style="text-align:center;">
          <div style="font-weight:700; color:var(--muted)">No public rides yet</div>
          <div style="color:var(--muted); margin-top:8px;">This user hasn't shared any public rides.</div>
        </div>
      {% endif %}
    </div>
  </div>
</body>
</html>